name: Deploy to Production VM

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (commit SHA or latest)'
        required: false
        default: 'latest'
      environment:
        description: 'Target environment'
        required: false
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set version to deploy
      id: version
      run: |
        if [ "${{ github.event.inputs.version }}" = "latest" ] || [ -z "${{ github.event.inputs.version }}" ]; then
          # Get the latest semantic version tag or fallback to commit SHA
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
          if [ -n "$LATEST_TAG" ]; then
            VERSION="$LATEST_TAG"
            echo "Using latest semantic version tag: $VERSION"
          else
            # Fallback to latest commit short SHA (matches Gradle build format)
            VERSION=$(git rev-parse --short origin/main)
            echo "No semantic version tags found, using latest commit short SHA: $VERSION"
            
            # Check if we need to prepend base version (matches Gradle CI format)
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              # This is a commit SHA, prepend base version like Gradle does
              VERSION="0.0.1-$VERSION"
              echo "Using Gradle CI version format: $VERSION"
            fi
          fi
        else
          VERSION="${{ github.event.inputs.version }}"
          echo "Using specified version: $VERSION"
        fi
        
        # Remove 'v' prefix if present for Maven compatibility
        VERSION="${VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Deploying version: $VERSION"

    - name: Validate required secrets
      run: |
        if [ -z "${{ secrets.VM_SSH_KEY }}" ]; then
          echo "Error: VM_SSH_KEY secret is not configured"
          exit 1
        fi
        if [ -z "${{ secrets.VM_HOST }}" ]; then
          echo "Error: VM_HOST secret is not configured"
          exit 1
        fi
        if [ -z "${{ secrets.VM_USER }}" ]; then
          echo "Error: VM_USER secret is not configured"
          exit 1
        fi

    - name: Setup SSH connection
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VM_SSH_KEY }}

    - name: Deploy to VM
      run: |
        # Set SSH connection variables
        SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        VM_HOST="${{ secrets.VM_HOST }}"
        VM_USER="${{ secrets.VM_USER }}"
        
        echo "Connecting to VM: $VM_USER@$VM_HOST"
        
        # Create deployment directory if it doesn't exist
        ssh $SSH_OPTS $VM_USER@$VM_HOST "mkdir -p ~/tg-admin-deployment"
        
        # Create deployment package locally
        ./scripts/create-deployment-package.sh
        
        # Copy only essential deployment files to VM
        # This preserves certbot data and avoids permission issues
        scp $SSH_OPTS -r deployment-package/* $VM_USER@$VM_HOST:~/tg-admin-deployment/
        
        # Clean up local deployment package
        rm -rf deployment-package
        
        # Execute deployment on VM
        ssh $SSH_OPTS $VM_USER@$VM_HOST << 'EOF'
          cd ~/tg-admin-deployment
          
          # Set environment variables
          export JAR_VERSION="${{ steps.version.outputs.version }}"
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          export DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
          export CERTBOT_EMAIL="${{ secrets.CERTBOT_EMAIL }}"
          
          echo "Starting deployment with version: $JAR_VERSION"
          
          # Make deploy script executable
          chmod +x deploy.sh
          
          # Run deployment
          ./deploy.sh
          
          # Check deployment status
          if [ $? -eq 0 ]; then
            echo "Deployment completed successfully"
          else
            echo "Deployment failed"
            exit 1
          fi
        EOF

    - name: Verify deployment
      run: |
        # Wait for application to start
        sleep 30
        
        # Health check
        VM_HOST="${{ secrets.VM_HOST }}"
        DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
        
        echo "Performing health check on https://$DOMAIN_NAME/health"
        
        if curl -f -s "https://$DOMAIN_NAME/health" > /dev/null; then
          echo "‚úÖ Health check passed - bot is running"
        else
          echo "‚ùå Health check failed - please check the logs"
          echo "Run: ssh ${{ secrets.VM_USER }}@$VM_HOST 'cd ~/tg-admin-deployment && docker compose logs bot'"
          exit 1
        fi

    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "üöÄ Deployment successful!"
          echo "Bot is running at: https://${{ secrets.DOMAIN_NAME }}"
          echo "Webhook URL: https://${{ secrets.DOMAIN_NAME }}/webhook"
          echo "Health check: https://${{ secrets.DOMAIN_NAME }}/health"
        else
          echo "‚ùå Deployment failed!"
          echo "Please check the logs and try again"
        fi